- name: Ensure tmp folder exists
  file: path=/tmp/wp_repos_zip state=directory mode=0755

- name: Copy w3tc_admin_url.patch to tmp folder
  copy: src=w3tc_admin_url.patch dest=/tmp/w3tc_admin_url.patch owner=www-data group=www-data mode=0755

- command: patch -R --dry-run -d /var/www/html/wp-content/plugins/w3-total-cache < w3tc_admin_url.patch
  register: patch_applied
  ignore_errors: True
    
- name: apply patch to w3tc
  shell: patch -R -d /var/www/html/wp-content/plugins/w3-total-cache < w3tc_admin_url.patch 
  args:
    chdir: /tmp/
  when: patch_applied|succeeded
  
- name: Clear /cache folder
  shell: rm -rf /cache/*
  
- name: Clear /tmp/wp_repos_zip
  shell: rm -rf /tmp/wp_repos_zip/*
  
# Statistics 

- name: Ensure stats folder exists
  file: path=/var/www/html/stats/ state=directory mode=0755

- name: Generating stats, copying script to tmp folder
  copy: src=generate_stats.py dest=/tmp/generate_stats.py owner=www-data group=www-data mode=0755
  
- name: Execute script
  shell: python generate_stats.py /var/www/html/stats/records_by_taxonomy.json
  args:
    chdir: /tmp/